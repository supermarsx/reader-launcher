name: Auto-release

on:
  workflow_run:
    workflows: ["Build"]
    types:
      - completed

jobs:
  publish-release:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Compute next release tag and create release
        id: create_release
        uses: actions/github-script@v6
        with:
          script: |
            const runId = context.payload.workflow_run.id
            const owner = context.repo.owner
            const repo = context.repo.repo

            // derive two-digit year
            const fullYear = new Date().getFullYear()
            const yy = String(fullYear).slice(-2)

            // list existing releases and find the highest numbered release for this year
            const releases = await github.rest.repos.listReleases({ owner, repo })
            let max = 0
            for (const r of releases.data) {
              const m = r.tag_name.match(new RegExp('^' + yy + '\\.(\\d+)$'))
              if (m) {
                const v = parseInt(m[1], 10)
                if (v > max) max = v
              }
            }
            const next = max + 1
            const tag = `${yy}.${next}`
            core.info(`Creating release ${tag}`)
            const rel = await github.rest.repos.createRelease({ owner, repo, tag_name: tag, name: tag, body: `Automated release ${tag}`, draft: false, prerelease: false })
            // export numeric release id for subsequent steps
            return rel.data.id

      - name: Download artifacts from successful Build run
        env:
          RUN_ID: ${{ github.event.workflow_run.id }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching artifacts for run $RUN_ID"
          API="https://api.github.com/repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts"
          curl -s -H "Authorization: Bearer $TOKEN" -H "Accept: application/vnd.github+json" "$API" > artifacts.json
          cat artifacts.json
          # find the artifact named reader-launcher-dist
          ART_URL=$(jq -r '.artifacts[] | select(.name=="reader-launcher-dist") | .archive_download_url' artifacts.json)
          if [ "$ART_URL" = "" ] || [ "$ART_URL" = "null" ]; then
            echo "No reader-launcher-dist artifact found for build run: $RUN_ID"
            exit 1
          fi
          echo "Found artifact: $ART_URL"
          curl -L -H "Authorization: Bearer $TOKEN" -o artifact.zip "$ART_URL"
          unzip -o artifact.zip -d artifact

      - name: Attach build artifacts to release
        env:
          RELEASE_ID: ${{ steps.create_release.outputs.result }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Attaching artifacts to release id $RELEASE_ID"
          REPO="${{ github.repository }}"
          # upload any files found under artifact/dist
          ls artifact
          if [ -d artifact/dist ]; then
            for f in artifact/dist/*; do
              fname=$(basename "$f")
              echo "Uploading $fname to release $RELEASE_ID"
              curl -s -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/octet-stream" --data-binary @"$f" "https://uploads.github.com/repos/$REPO/releases/$RELEASE_ID/assets?name=$fname"
            done
          else
            echo "No artifact/dist found to upload"
            exit 1
          fi

      - name: VirusTotal scan or provide detection URLs
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VTKEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
        run: |
          mkdir -p vt_results
          if [ -d artifact/dist ]; then
            for f in artifact/dist/*; do
              fname=$(basename "$f")
              sha256=$(sha256sum "$f" | awk '{print $1}')
              echo "File: $fname SHA256: $sha256" >> vt_results/scan_summary.txt
              if [ -n "$VTKEY" ]; then
                echo "Uploading $fname to VirusTotal..."
                response=$(curl -s -X POST "https://www.virustotal.com/api/v3/files" -H "x-apikey: $VTKEY" -F file=@"$f")
                analysisId=$(echo "$response" | jq -r '.data.id')
                if [ "$analysisId" = "null" -o -z "$analysisId" ]; then
                  echo "No analysis ID returned for $fname" >> vt_results/scan_summary.txt
                  continue
                fi
                echo "Analysis id: $analysisId" >> vt_results/scan_summary.txt
                # poll analysis endpoint
                for i in {1..12}; do
                  sleep 5
                  report=$(curl -s -X GET "https://www.virustotal.com/api/v3/analyses/$analysisId" -H "x-apikey: $VTKEY")
                  status=$(echo "$report" | jq -r '.data.attributes.status')
                  if [ "$status" = "completed" ]; then
                    stats=$(echo "$report" | jq -r '.data.attributes.stats | to_entries | map("") | .')
                    # write a summarized result
                    malicious=$(echo "$report" | jq -r '.data.attributes.stats.malicious')
                    suspicious=$(echo "$report" | jq -r '.data.attributes.stats.suspicious')
                    echo "Result for $fname: malicious=$malicious suspicious=$suspicious" >> vt_results/scan_summary.txt
                    break
                  fi
                done
              else
                # No API key â€” record manual GUI link to check:
                echo "VirusTotal GUI link: https://www.virustotal.com/gui/file/$sha256/detection" >> vt_results/scan_summary.txt
              fi
            done
            # upload scan_summary.txt to the release
            RELEASE_ID=${{ steps.create_release.outputs.result }}
            if [ -f vt_results/scan_summary.txt ]; then
              echo "Attaching vt_results/scan_summary.txt to release $RELEASE_ID"
              curl -s -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/octet-stream" --data-binary @vt_results/scan_summary.txt "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=vt_scan_summary.txt"
            fi
          else
            echo "No artifacts found to scan"
          fi

      - name: Verify artifacts against checksums and optionally query VirusTotal
        env:
          VTKEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p vt_results
          if [ -d artifact/dist ]; then
            for f in artifact/dist/*; do
              fname=$(basename "$f")
              echo "--- Verifying $fname ---" >> vt_results/verify_summary.txt
              # Use PowerShell helper to verify checksums and optionally query VT
              pwsh -NoProfile -ExecutionPolicy Bypass -File scripts/verify-release.ps1 -ArtifactPath "$f" -Checksums artifact/dist/checksums.txt -VtKey "$VTKEY" >> vt_results/verify_summary.txt 2>&1 || true
            done
            # attach verify_summary to release for convenience
            RELEASE_ID=${{ steps.create_release.outputs.result }}
            if [ -f vt_results/verify_summary.txt ]; then
              echo "Attaching vt_results/verify_summary.txt to release $RELEASE_ID"
              curl -s -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/octet-stream" --data-binary @vt_results/verify_summary.txt "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=vt_verify_summary.txt"
            fi
          else
            echo "No artifacts found to verify"
          fi
